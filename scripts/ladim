#! /usr/bin/env python

import argparse
import logging
import datetime
from pathlib import Path

#from .ladim import main

from ladim import main

# ====================
# Parse command line
# ====================

parser = argparse.ArgumentParser(
    description='LADiM â€” Lagrangian Advection and Diffusion Model')
parser.add_argument(
    '-d', '--debug',
    help="Show more information",
    action="store_const", dest="loglevel", const=logging.DEBUG,
    default=logging.INFO)
parser.add_argument(
    '-s', '--silent',
    help='Show less information',
    action="store_const", dest="loglevel", const=logging.WARNING)
parser.add_argument('config_file', nargs='?', default='ladim.yaml')
args = parser.parse_args()

# =============
# Sanity check
# =============

if not Path(args.config_file).exists:
    raise SystemExit('ERROR: Configuration file not found')

# =========
# Logging
# =========

logging.basicConfig(
    level=args.loglevel,
    format='%(levelname)s:%(module)s - %(message)s')

# ===================
# Run the simulation
# ===================

now = datetime.datetime.now().replace(microsecond=0)
logging.info(f'LADiM simulation starting, wafll time={now}')

try:
    fp = open(args.config_file, encoding='utf8')
except FileNotFoundError:
    print('ERROR: ', f'Configuration file {config_file} not found')
    raise SystemExit(1)

main(config_stream=fp, loglevel=args.loglevel)

now = datetime.datetime.now().replace(microsecond=0)
logging.info(f'LADiM simulation finished, wall time={now}')
